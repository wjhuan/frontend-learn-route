<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>HTTP核心概念 | 前端食堂</title>
    <meta name="description" content="">
    <meta name="generator" content="VuePress 1.9.8">
    <link rel="icon" href="/assets/logo.png">
    <meta name="description" content="A lightweight creator for VuePress project.">
    <link rel="preload" href="/assets/css/0.styles.a0bdfdfc.css" as="style"><link rel="preload" href="/assets/js/app.35af8aa6.js" as="script"><link rel="preload" href="/assets/js/3.dc37dcdc.js" as="script"><link rel="preload" href="/assets/js/7.20c81c08.js" as="script"><link rel="prefetch" href="/assets/js/10.612e230f.js"><link rel="prefetch" href="/assets/js/11.c101dc61.js"><link rel="prefetch" href="/assets/js/12.aaf27af1.js"><link rel="prefetch" href="/assets/js/13.24769d74.js"><link rel="prefetch" href="/assets/js/14.310913e8.js"><link rel="prefetch" href="/assets/js/15.ec24d364.js"><link rel="prefetch" href="/assets/js/16.d6d82031.js"><link rel="prefetch" href="/assets/js/17.d2a81a23.js"><link rel="prefetch" href="/assets/js/18.2b797387.js"><link rel="prefetch" href="/assets/js/19.8d75321d.js"><link rel="prefetch" href="/assets/js/20.83a9917d.js"><link rel="prefetch" href="/assets/js/21.0c2cb078.js"><link rel="prefetch" href="/assets/js/22.5a162c1b.js"><link rel="prefetch" href="/assets/js/23.f013f4a1.js"><link rel="prefetch" href="/assets/js/24.18e3ea48.js"><link rel="prefetch" href="/assets/js/25.81286a3a.js"><link rel="prefetch" href="/assets/js/26.357d2d2f.js"><link rel="prefetch" href="/assets/js/27.49919d46.js"><link rel="prefetch" href="/assets/js/28.0ec81da1.js"><link rel="prefetch" href="/assets/js/29.ba8366b6.js"><link rel="prefetch" href="/assets/js/30.838d7d5b.js"><link rel="prefetch" href="/assets/js/31.1f3978fe.js"><link rel="prefetch" href="/assets/js/32.0d77346e.js"><link rel="prefetch" href="/assets/js/33.69399d1b.js"><link rel="prefetch" href="/assets/js/34.10e92eec.js"><link rel="prefetch" href="/assets/js/35.da0e2d38.js"><link rel="prefetch" href="/assets/js/36.458f916d.js"><link rel="prefetch" href="/assets/js/37.82be7a94.js"><link rel="prefetch" href="/assets/js/38.536d8a73.js"><link rel="prefetch" href="/assets/js/39.6d019b73.js"><link rel="prefetch" href="/assets/js/4.52b1f8fa.js"><link rel="prefetch" href="/assets/js/40.f04d3760.js"><link rel="prefetch" href="/assets/js/41.8775852e.js"><link rel="prefetch" href="/assets/js/42.b812073d.js"><link rel="prefetch" href="/assets/js/43.549978ae.js"><link rel="prefetch" href="/assets/js/44.275c6310.js"><link rel="prefetch" href="/assets/js/45.49e7e194.js"><link rel="prefetch" href="/assets/js/46.29808115.js"><link rel="prefetch" href="/assets/js/47.10da2067.js"><link rel="prefetch" href="/assets/js/48.1e323c0c.js"><link rel="prefetch" href="/assets/js/49.257eb328.js"><link rel="prefetch" href="/assets/js/5.9fb1676b.js"><link rel="prefetch" href="/assets/js/50.8fecaeb9.js"><link rel="prefetch" href="/assets/js/51.12524026.js"><link rel="prefetch" href="/assets/js/52.1934343b.js"><link rel="prefetch" href="/assets/js/53.af9b8d9c.js"><link rel="prefetch" href="/assets/js/54.ef375a01.js"><link rel="prefetch" href="/assets/js/55.b68b9cd4.js"><link rel="prefetch" href="/assets/js/56.c7a8ace3.js"><link rel="prefetch" href="/assets/js/57.c21beeac.js"><link rel="prefetch" href="/assets/js/58.d3b315da.js"><link rel="prefetch" href="/assets/js/59.753d7ba7.js"><link rel="prefetch" href="/assets/js/6.2a7cfe6c.js"><link rel="prefetch" href="/assets/js/60.29ca43c1.js"><link rel="prefetch" href="/assets/js/61.c0eead57.js"><link rel="prefetch" href="/assets/js/62.d48b7849.js"><link rel="prefetch" href="/assets/js/63.77aff366.js"><link rel="prefetch" href="/assets/js/64.5718074c.js"><link rel="prefetch" href="/assets/js/65.007ebc5d.js"><link rel="prefetch" href="/assets/js/66.1b81f6aa.js"><link rel="prefetch" href="/assets/js/67.19275aba.js"><link rel="prefetch" href="/assets/js/68.28e6d2ec.js"><link rel="prefetch" href="/assets/js/8.a60053fd.js"><link rel="prefetch" href="/assets/js/9.06b52a05.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.25429ca7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a0bdfdfc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="ant-row"><div class="sidebar-button"><i aria-label="icon: bars" class="anticon anticon-bars"><svg viewBox="0 0 1024 1024" focusable="false" data-icon="bars" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M912 192H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 284H328c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h584c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM104 228a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0zm0 284a56 56 0 1 0 112 0 56 56 0 1 0-112 0z"></path></svg></i> <span></span></div> <div class="ant-col ant-col-xs-24 ant-col-sm-24 ant-col-md-6 ant-col-lg-5 ant-col-xl-5 ant-col-xxl-4"><a href="/" class="router-link-active no-logo home-link"><!----> <span class="site-name">前端食堂</span></a> <div class="search-box mobile-search"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="ant-col ant-col-xs-0 ant-col-sm-0 ant-col-md-18 ant-col-lg-19 ant-col-xl-19 ant-col-xxl-20"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><a class="ant-dropdown-link ant-dropdown-trigger">
      Hover me <i aria-label="icon: down" class="anticon anticon-down"><svg viewBox="64 64 896 896" focusable="false" data-icon="down" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M884 256h-75c-5.1 0-9.9 2.5-12.9 6.6L512 654.2 227.9 262.6c-3-4.1-7.8-6.6-12.9-6.6h-75c-6.5 0-10.3 7.4-6.5 12.7l352.6 486.1c12.8 17.6 39 17.6 51.7 0l352.6-486.1c3.9-5.3.1-12.7-6.4-12.7z"></path></svg></i></a> <a href="https://github.com/wjhuan/frontend-learn-route" target="_blank" rel="noopener noreferrer" class="repo-link"><i aria-label="icon: github" class="anticon anticon-github"><svg viewBox="64 64 896 896" focusable="false" data-icon="github" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M511.6 76.3C264.3 76.2 64 276.4 64 523.5 64 718.9 189.3 885 363.8 946c23.5 5.9 19.9-10.8 19.9-22.2v-77.5c-135.7 15.9-141.2-73.9-150.3-88.9C215 726 171.5 718 184.5 703c30.9-15.9 62.4 4 98.9 57.9 26.4 39.1 77.9 32.5 104 26 5.7-23.5 17.9-44.5 34.7-60.8-140.6-25.2-199.2-111-199.2-213 0-49.5 16.3-95 48.3-131.7-20.4-60.5 1.9-112.3 4.9-120 58.1-5.2 118.5 41.6 123.2 45.3 33-8.9 70.7-13.6 112.9-13.6 42.4 0 80.2 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.3-43.9 2.9 7.7 24.7 58.3 5.5 118 32.4 36.8 48.9 82.7 48.9 132.3 0 102.2-59 188.1-200 212.9a127.5 127.5 0 0 1 38.1 91v112.5c.8 9 0 17.9 15 17.9 177.1-59.7 304.6-227 304.6-424.1 0-247.2-200.4-447.3-447.5-447.3z"></path></svg></i></a></nav></div></div> <!----></header> <aside class="sidebar"><!----> <ul class="sidebar-links"><li><a href="/node/" aria-current="page" title="README.md" class="sidebar-link">README.md</a></li><li><a href="/node/article-1.html" title="高阶函数" class="sidebar-link">高阶函数</a></li><li><a href="/node/article-2.html" title="初识Promise" class="sidebar-link">初识Promise</a></li><li><a href="/node/article-3.html" title="异步编程" class="sidebar-link">异步编程</a></li><li><a href="/node/article-5.html" title="Event Loop" class="sidebar-link">Event Loop</a></li><li><a href="/node/article-6.html" title="Node" class="sidebar-link">Node</a></li><li><a href="/node/article-7.html" title="npm" class="sidebar-link">npm</a></li><li><a href="/node/article-8.html" title="buffer" class="sidebar-link">buffer</a></li><li><a href="/node/article-9.html" aria-current="page" title="HTTP核心概念" class="active sidebar-link">HTTP核心概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/node/article-9.html#什么是-http-应用层" title="什么是 HTTP?应用层" class="sidebar-link">什么是 HTTP?应用层</a></li><li class="sidebar-sub-header"><a href="/node/article-9.html#tcp-ip-协议族-http-应用层协议-在传输层的基础上增加了一些自己的内容" title="TCP/IP 协议族 (HTTP 应用层协议 在传输层的基础上增加了一些自己的内容)" class="sidebar-link">TCP/IP 协议族 (HTTP 应用层协议 在传输层的基础上增加了一些自己的内容)</a></li><li class="sidebar-sub-header"><a href="/node/article-9.html#协议分层-osi-协议分层" title="协议分层(OSI 协议分层)" class="sidebar-link">协议分层(OSI 协议分层)</a></li><li class="sidebar-sub-header"><a href="/node/article-9.html#http-特点" title="HTTP 特点" class="sidebar-link">HTTP 特点</a></li><li class="sidebar-sub-header"><a href="/node/article-9.html#http-缺点" title="HTTP 缺点" class="sidebar-link">HTTP 缺点</a></li><li class="sidebar-sub-header"><a href="/node/article-9.html#http-方法-get-post-简单请求-resful-风格" title="HTTP 方法 (get post 简单请求) Resful 风格" class="sidebar-link">HTTP 方法 (get post 简单请求) Resful 风格</a></li><li class="sidebar-sub-header"><a href="/node/article-9.html#http-状态码-发请求-命令行-curl-命令-服务端" title="HTTP 状态码 (发请求 命令行 curl 命令) 服务端" class="sidebar-link">HTTP 状态码 (发请求 命令行 curl 命令) 服务端</a></li><li class="sidebar-sub-header"><a href="/node/article-9.html#http-客户端和服务端通信" title="http 客户端和服务端通信" class="sidebar-link">http 客户端和服务端通信</a></li><li class="sidebar-sub-header"><a href="/node/article-9.html#报文应用" title="报文应用" class="sidebar-link">报文应用</a></li><li class="sidebar-sub-header"><a href="/node/article-9.html#实现静态服务" title="实现静态服务" class="sidebar-link">实现静态服务</a></li><li class="sidebar-sub-header"><a href="/node/article-9.html#通过类改写静态服务" title="通过类改写静态服务" class="sidebar-link">通过类改写静态服务</a></li><li class="sidebar-sub-header"><a href="/node/article-9.html#ajax-跨域问题" title="ajax 跨域问题" class="sidebar-link">ajax 跨域问题</a></li><li class="sidebar-sub-header"><a href="/node/article-9.html#http-缓存问题" title="http 缓存问题" class="sidebar-link">http 缓存问题</a></li><li class="sidebar-sub-header"><a href="/node/article-9.html#压缩与解压缩处理-accept-encoding" title="压缩与解压缩处理(accept-encoding)" class="sidebar-link">压缩与解压缩处理(accept-encoding)</a></li><li class="sidebar-sub-header"><a href="/node/article-9.html#多语言-accept-language" title="多语言 (accept-language)" class="sidebar-link">多语言 (accept-language)</a></li><li class="sidebar-sub-header"><a href="/node/article-9.html#cookie-session-实现登录权限" title="cookie+session 实现登录权限" class="sidebar-link">cookie+session 实现登录权限</a></li><li class="sidebar-sub-header"><a href="/node/article-9.html#什么是-jwt" title="什么是 jwt？" class="sidebar-link">什么是 jwt？</a></li></ul></li></ul></aside> <main class="page"> <div class="theme-antdocs-content content__default"><h1 id="http-核心概念"><a href="#http-核心概念" class="header-anchor">#</a> HTTP 核心概念</h1> <h2 id="什么是-http-应用层"><a href="#什么是-http-应用层" class="header-anchor">#</a> 什么是 HTTP?应用层</h2> <p>通常的网络是在 TCP/IP 协议族的基础上来运作的，HTTP 是一个子集。</p> <h2 id="tcp-ip-协议族-http-应用层协议-在传输层的基础上增加了一些自己的内容"><a href="#tcp-ip-协议族-http-应用层协议-在传输层的基础上增加了一些自己的内容" class="header-anchor">#</a> TCP/IP 协议族 (HTTP 应用层协议 在传输层的基础上增加了一些自己的内容)</h2> <p>协议简单来说就是通信的规则，例如：通信时谁先发起请求，怎样结束，如何进行通信。把互联网相关的协议统称起来称为 TCP/IP</p> <h2 id="协议分层-osi-协议分层"><a href="#协议分层-osi-协议分层" class="header-anchor">#</a> 协议分层(OSI 协议分层)</h2> <blockquote><p>(物，数)，网，传，(会，表，应)</p></blockquote> <ul><li><p>应用层 HTTP,FTP,DNS (与其他计算机进行通讯的一个应用服务，向用户提供应用服务时的通信活动)</p></li> <li><p>传输层 TCP（可靠） UDP 数据传输 (HTTP -&gt; TCP DNS-&gt;UDP)</p></li> <li><p>网络层 IP 选择传输路线 (通过 ip 地址和 mac 地址)(使用 ARP 协议凭借 mac 地址进行通信)</p></li> <li><p>链路层 网络连接的硬件部分</p></li></ul> <p><img src="/assets/img/tpchttp.494cefeb.png" alt=""></p> <h2 id="http-特点"><a href="#http-特点" class="header-anchor">#</a> HTTP 特点</h2> <ul><li>http 是不保存状态的协议，使用 cookie 来管理状态 (登录 先给你 cookie 我可以看一下你有没有 cookie)</li> <li>为了防止每次请求都会造成无谓的 tcp 链接建立和断开，所以采用保持链接的方式 keep-alive</li> <li>以前发送请求后需要等待并收到响应，才能发下一个，现在都是管线化的方式 (js css 可以并发请求 6 2) cdn</li></ul> <h2 id="http-缺点"><a href="#http-缺点" class="header-anchor">#</a> HTTP 缺点</h2> <ol><li>通信采用明文</li> <li>不验证通信方的身份</li> <li>无法验证内容的完整性 (内容可能被篡改)
<blockquote><p>通过 SSL（安全套阶层）建立安全通信线路 HTTPS (超文本传输安全协议)</p></blockquote></li></ol> <h2 id="http-方法-get-post-简单请求-resful-风格"><a href="#http-方法-get-post-简单请求-resful-风格" class="header-anchor">#</a> HTTP 方法 (get post 简单请求) Resful 风格</h2> <ul><li><p>GET:获取资源 /user？</p></li> <li><p>POST:传输实体主体 请求体中</p></li> <li><p>PUT：来传输文件</p></li> <li><p>HEAD: 获取报文首</p></li> <li><p>DELETE: 删除文件</p></li> <li><p>OPTIONS:询问支持的方法 跨域 如果默认发送的是 get/post 不会发送 options 的 &quot;&quot;复杂请求&quot;&quot;</p></li> <li><p>get /post (a:1) headers:{a:1} put / delete 复杂的请求</p></li></ul> <h2 id="http-状态码-发请求-命令行-curl-命令-服务端"><a href="#http-状态码-发请求-命令行-curl-命令-服务端" class="header-anchor">#</a> HTTP 状态码 (发请求 命令行 curl 命令) 服务端</h2> <ul><li><p>curl 命令行工具 postman</p></li> <li><p>1xx 信息性状态码 websocket upgrade</p></li> <li><p>2xx 成功状态码 200 204(没有响应体) 206(范围请求 暂停继续下载) 获取网页的部分请求</p></li> <li><p>3xx 重定向状态码 301 302 303 post -&gt; get 304(删除报文主体 在次发送请求) 307 (不会从 POST 转为 GET)</p></li> <li><p>4xx 客户端错误状态码 400 401 403 404 405 方法不允许</p></li> <li><p>5xx 服务端错误状态码 500 503</p></li></ul> <h2 id="http-客户端和服务端通信"><a href="#http-客户端和服务端通信" class="header-anchor">#</a> http 客户端和服务端通信</h2> <p>Http 报文，http 交互的信息称之为 http 报文</p> <p><img src="/assets/img/requestheader.b05e9e2b.png" alt=""></p> <p>通用首部字段：请求和响应报文都有的首部</p> <p>实体首部字段：描述实体部分的字段</p> <p><img src="/assets/img/request.a7175082.png" alt=""> <img src="/assets/img/response.48ae0e35.png" alt=""></p> <h2 id="报文应用"><a href="#报文应用" class="header-anchor">#</a> 报文应用</h2> <ul><li><p>Content-Encoding : gzip 压缩 form-data: 多部分对象集合 上传文件</p></li> <li><p>range: 范围请求 206 accept-language：内容协商 前端控制 后端控制</p></li> <li><p>host：单主机多域名 304 http 缓存</p></li> <li><p>referer:访问来源 防盗链 proxy:代理、网关和隧道</p></li> <li><p>user-agent:用户内核 安全相关的头: X-Frame-Options、X-XSS-Protection (安全 csrf xss https 加密)</p></li></ul> <h2 id="实现静态服务"><a href="#实现静态服务" class="header-anchor">#</a> 实现静态服务</h2> <p>mime 模块处理请求文件类型</p> <div class="language-js extra-class"><pre class="language-js"><code>npm install mime <span class="token operator">-</span>g
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> pathname <span class="token punctuation">}</span> <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
  <span class="token comment">// 根据请求路径查找文件</span>
  <span class="token keyword">let</span> absFilePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> pathname<span class="token punctuation">)</span>
  fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>absFilePath<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> stat</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Not Found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 尝试查找index.html</span>
      absFilePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>absFilePath<span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span>
      fs<span class="token punctuation">.</span><span class="token function">access</span><span class="token punctuation">(</span>absFilePath<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Not Found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> type <span class="token operator">=</span> mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span>absFilePath<span class="token punctuation">)</span>
          res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> type <span class="token operator">+</span> <span class="token string">';charset=utf-8'</span><span class="token punctuation">)</span>
          fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>absFilePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> type <span class="token operator">=</span> mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span>absFilePath<span class="token punctuation">)</span>
      res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> type <span class="token operator">+</span> <span class="token string">';charset=utf-8'</span><span class="token punctuation">)</span>
      fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>absFilePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="通过类改写静态服务"><a href="#通过类改写静态服务" class="header-anchor">#</a> 通过类改写静态服务</h2> <p>通过 async 和 await 改写主体流程</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>promises
<span class="token keyword">let</span> <span class="token punctuation">{</span> createReadStream <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> mime <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mime'</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">Server</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">handleServer</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">{</span> pathname <span class="token punctuation">}</span> <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token keyword">let</span> absFilePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> pathname<span class="token punctuation">)</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> statObj <span class="token operator">=</span> <span class="token keyword">await</span> fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>absFilePath<span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>statObj<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        absFilePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>absFilePath<span class="token punctuation">,</span> <span class="token string">'index.html'</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendFile</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> absFilePath<span class="token punctuation">,</span> statObj<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendError</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">sendFile</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> absFilePath<span class="token punctuation">,</span> statObj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> type <span class="token operator">=</span> mime<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span>absFilePath<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> type <span class="token operator">+</span> <span class="token string">';charset=utf-8'</span><span class="token punctuation">)</span>
    <span class="token function">createReadStream</span><span class="token punctuation">(</span>absFilePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">sendError</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span>statusCode <span class="token operator">=</span> <span class="token number">404</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Not Found</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleServer</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>arguments<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Server</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="ajax-跨域问题"><a href="#ajax-跨域问题" class="header-anchor">#</a> ajax 跨域问题</h2> <p>cors 解决跨域问题</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span> <span class="token string">'http://a.zf.cn:5000'</span> <span class="token comment">// 允许某个域访问</span>
<span class="token string">'Access-Control-Allow-Credentials'</span><span class="token punctuation">,</span> <span class="token string">'true'</span> <span class="token comment">// 允许携带cookie</span>
<span class="token string">'Access-Control-Allow-Headers'</span><span class="token punctuation">,</span> <span class="token string">'a'</span> <span class="token comment">// 允许携带的header</span>
<span class="token string">'Access-Control-Max-Age'</span><span class="token punctuation">,</span> <span class="token string">'3600'</span> <span class="token comment">// 设置options的请求发送时长</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'http://localhost:5000/user'</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
xhr<span class="token punctuation">.</span><span class="token function">setRequestHeader</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">)</span> <span class="token comment">// 设置请求头</span>

xhr<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>xhr<span class="token punctuation">.</span>responseText<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span>withCredentials <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 设置强制携带cookie</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>跨域配置</p> <div class="language-js extra-class"><pre class="language-js"><code>res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span><span class="token punctuation">,</span> <span class="token string">'http://a.zf.cn:5000'</span><span class="token punctuation">)</span>
res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Credentials'</span><span class="token punctuation">,</span> <span class="token string">'true'</span><span class="token punctuation">)</span>
res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Max-Age'</span><span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">)</span>
res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Headers'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>method <span class="token operator">===</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// options请求直接结束即可</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="http-缓存问题"><a href="#http-缓存问题" class="header-anchor">#</a> http 缓存问题</h2> <ol><li>强制缓存 (Cache-Control &amp;&amp; Expires)</li></ol> <p>Cache-Control:</p> <ul><li>private 客户端可以缓存</li> <li>public 客户端和代理服务器都可以缓存</li> <li>max-age=60 缓存内容将在 60 秒后失效</li> <li>no-cache 需要使用对比缓存验证数据,强制向源服务器再次验证 (没有强制缓存)</li> <li>no-store 所有内容都不会缓存，强制缓存和对比缓存都不会触发 (不缓存)</li></ul> <p><img src="/assets/img/cache2.10b59301.png" alt=""></p> <ol start="2"><li>对比缓存</li></ol> <ul><li>Last-Modified &amp; If-Modified-Since</li></ul> <p>​- ETag &amp; If-None-Match</p> <p><img src="/assets/img/cache4.48f982ec.png" alt=""></p> <h2 id="压缩与解压缩处理-accept-encoding"><a href="#压缩与解压缩处理-accept-encoding" class="header-anchor">#</a> 压缩与解压缩处理(accept-encoding)</h2> <p>使用 GZIP / DEFLATE 实现解压</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> zlib <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'zlib'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
http
  <span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">request<span class="token punctuation">,</span> response</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> raw <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'.'</span> <span class="token operator">+</span> request<span class="token punctuation">.</span>url<span class="token punctuation">)</span>
    <span class="token keyword">var</span> acceptEncoding <span class="token operator">=</span> request<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'accept-encoding'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>acceptEncoding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      acceptEncoding <span class="token operator">=</span> <span class="token string">''</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>acceptEncoding<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\bdeflate\b</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Encoding'</span><span class="token punctuation">,</span> <span class="token string">'deflate'</span><span class="token punctuation">)</span>
      raw<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>zlib<span class="token punctuation">.</span><span class="token function">createDeflate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>acceptEncoding<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\bgzip\b</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Encoding'</span><span class="token punctuation">,</span> <span class="token string">'gzip'</span><span class="token punctuation">)</span>
      raw<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>zlib<span class="token punctuation">.</span><span class="token function">createGzip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      raw<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9090</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="多语言-accept-language"><a href="#多语言-accept-language" class="header-anchor">#</a> 多语言 (accept-language)</h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> pack <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">en</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'hello'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">cn</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token string">'欢迎'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> acceptLangulage <span class="token operator">=</span> req<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'accept-language'</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> lan <span class="token operator">=</span> <span class="token string">'en'</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>acceptLangulage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lan <span class="token operator">=</span> acceptLangulage
      <span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> values <span class="token operator">=</span> item<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">';'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">name</span><span class="token operator">:</span> values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token literal-property property">q</span><span class="token operator">:</span> <span class="token function">isNaN</span><span class="token punctuation">(</span>values<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>values<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">lan1<span class="token punctuation">,</span> lan2</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> lan1<span class="token punctuation">.</span>q <span class="token operator">-</span> lan2<span class="token punctuation">.</span>q<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>name
  <span class="token punctuation">}</span>
  res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>pack<span class="token punctuation">[</span>lan<span class="token punctuation">]</span> <span class="token operator">?</span> pack<span class="token punctuation">[</span>lan<span class="token punctuation">]</span><span class="token punctuation">.</span>title <span class="token operator">:</span> pack<span class="token punctuation">[</span><span class="token string">'en'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>title<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> request<span class="token punctuation">)</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="cookie-session-实现登录权限"><a href="#cookie-session-实现登录权限" class="header-anchor">#</a> cookie+session 实现登录权限</h2> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">yarn</span> <span class="token function">add</span> koa koa-router koa-views koa-bodyparser koa-session
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> bodyparser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-bodyparser'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> views <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-views'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> session <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-session'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyparser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'zf'</span><span class="token punctuation">]</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  <span class="token function">views</span><span class="token punctuation">(</span>__dirname <span class="token operator">+</span> <span class="token string">'/views'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">map</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">html</span><span class="token operator">:</span> <span class="token string">'ejs'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 默认访问首页</span>
  <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'home.html'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
  <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">===</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 用户名和密码相等就认为用户登录过了</span>
    ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token punctuation">{</span> username <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/list'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 登陆后才能访问 获取列表页面</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> username <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>user <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>username<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> r <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'list.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> username <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="什么是-jwt"><a href="#什么是-jwt" class="header-anchor">#</a> 什么是 jwt？</h2> <blockquote><p>JSON Web Token（JWT）是目前最流行的跨域身份验证解决方案</p></blockquote> <p>解决问题：session 不支持分布式架构，无法支持横向扩展，只能通过数据库来保存会话数据实现共享。如果持久层失败会出现认证失败。</p> <p>优点：服务器不保存任何会话数据，即服务器变为无状态，使其更容易扩展。</p> <p>JWT 包含了使用.分隔的三部分</p> <ul><li>Header 头部</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span> <span class="token string-property property">&quot;alg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HS256&quot;</span><span class="token punctuation">,</span> <span class="token string-property property">&quot;typ&quot;</span><span class="token operator">:</span> <span class="token string">&quot;JWT&quot;</span><span class="token punctuation">}</span>
<span class="token comment">// algorithm =&gt; HMAC SHA256</span>
<span class="token comment">// type =&gt; JWT</span>
</code></pre></div><ul><li>Payload 负载、载荷</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">JWT</span> 规定了<span class="token number">7</span>个官方字段
<span class="token function">iss</span> <span class="token punctuation">(</span>issuer<span class="token punctuation">)</span>：签发人
<span class="token function">exp</span> <span class="token punctuation">(</span>expiration time<span class="token punctuation">)</span>：过期时间
<span class="token function">sub</span> <span class="token punctuation">(</span>subject<span class="token punctuation">)</span>：主题
<span class="token function">aud</span> <span class="token punctuation">(</span>audience<span class="token punctuation">)</span>：受众
<span class="token function">nbf</span> <span class="token punctuation">(</span>Not Before<span class="token punctuation">)</span>：生效时间
<span class="token function">iat</span> <span class="token punctuation">(</span>Issued At<span class="token punctuation">)</span>：签发时间
<span class="token function">jti</span> <span class="token punctuation">(</span><span class="token constant">JWT</span> <span class="token constant">ID</span><span class="token punctuation">)</span>：编号
</code></pre></div><ul><li>Signature 签名
对前两部分的签名，防止数据篡改</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token constant">HMACSHA256</span><span class="token punctuation">(</span><span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>header<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.'</span> <span class="token operator">+</span> <span class="token function">base64UrlEncode</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span>
</code></pre></div><p>JWT 作为一个令牌（token），有些场合可能会放到 URL（比如 api.example.com/?token=xxx）。Base64 有三个字符+、/和=，在 URL 里面有特殊含义，所以要被替换掉：=被省略、+替换成-，/替换成_ 。这就是 Base64URL 算法。</p> <h3 id="使用方式"><a href="#使用方式" class="header-anchor">#</a> 使用方式</h3> <p>HTTP 请求的头信息 Authorization 字段里面</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token literal-property property">Authorization</span><span class="token operator">:</span> Bearer <span class="token operator">&lt;</span>token<span class="token operator">&gt;</span>
</code></pre></div><p>通过 url 传输</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token literal-property property">http</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>xxx<span class="token punctuation">.</span>com<span class="token operator">/</span>pwa<span class="token operator">?</span>token<span class="token operator">=</span>xxxxx
</code></pre></div><p>如果是 post 请求也可以放在请求体中</p> <h3 id="实际应用"><a href="#实际应用" class="header-anchor">#</a> 实际应用</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> bodyparser <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-bodyparser'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jwt-simple'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyparser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> secret <span class="token operator">=</span> <span class="token string">'zfpx'</span>
<span class="token comment">// 验证是否登陆</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span> username<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body
  <span class="token keyword">if</span> <span class="token punctuation">(</span>username <span class="token operator">===</span> <span class="token string">'admin'</span> <span class="token operator">&amp;&amp;</span> password <span class="token operator">===</span> <span class="token string">'admin'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> secret<span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
      username<span class="token punctuation">,</span>
      token<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 验证是否有权限</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/validate'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> Authorization <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'authorization'</span><span class="token punctuation">)</span>
  <span class="token keyword">let</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> token<span class="token punctuation">]</span> <span class="token operator">=</span> Authorization<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> r <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> secret<span class="token punctuation">)</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">200</span><span class="token punctuation">,</span>
        <span class="token literal-property property">username</span><span class="token operator">:</span> r<span class="token punctuation">,</span>
        token<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">401</span><span class="token punctuation">,</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">'没有登陆'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token number">401</span><span class="token punctuation">,</span>
      <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token string">'没有登陆'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="原理实现"><a href="#原理实现" class="header-anchor">#</a> 原理实现</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> myJwt <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">sign</span><span class="token punctuation">(</span><span class="token parameter">content<span class="token punctuation">,</span> secret</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> r <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">createHmac</span><span class="token punctuation">(</span><span class="token string">'sha256'</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">base64urlEscape</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">base64urlEscape</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\+</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\/</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">=</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">toBase64</span><span class="token punctuation">(</span><span class="token parameter">content</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">base64urlEscape</span><span class="token punctuation">(</span>
      Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token string">'base64'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">encode</span><span class="token punctuation">(</span><span class="token parameter">username<span class="token punctuation">,</span> secret</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> header <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toBase64</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">typ</span><span class="token operator">:</span> <span class="token string">'JWT'</span><span class="token punctuation">,</span> <span class="token literal-property property">alg</span><span class="token operator">:</span> <span class="token string">'HS256'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> content <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toBase64</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span>
    <span class="token keyword">let</span> sign <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">[</span>header<span class="token punctuation">,</span> content<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>header<span class="token punctuation">,</span> content<span class="token punctuation">,</span> sign<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">base64urlUnescape</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    str <span class="token operator">+=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token number">5</span> <span class="token operator">-</span> <span class="token punctuation">(</span>str<span class="token punctuation">.</span>length <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\-</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">_</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">decode</span><span class="token punctuation">(</span><span class="token parameter">token<span class="token punctuation">,</span> secret</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token punctuation">[</span>header<span class="token punctuation">,</span> content<span class="token punctuation">,</span> sign<span class="token punctuation">]</span> <span class="token operator">=</span> token<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span>
    <span class="token keyword">let</span> newSign <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">[</span>header<span class="token punctuation">,</span> content<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> secret<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sign <span class="token operator">===</span> newSign<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">base64urlUnescape</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'base64'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'被篡改'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">7/20/2023, 5:50:58 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/node/article-8.html" class="prev"><i aria-label="icon: left" class="anticon anticon-left"><svg viewBox="64 64 896 896" focusable="false" data-icon="left" width="1em" height="1em" fill="currentColor" aria-hidden="true"><path d="M724 218.3V141c0-6.7-7.7-10.4-12.9-6.3L260.3 486.8a31.86 31.86 0 0 0 0 50.3l450.8 352.1c5.3 4.1 12.9.4 12.9-6.3v-77.3c0-4.9-2.3-9.6-6.1-12.6l-360-281 360-281.1c3.8-3 6.1-7.7 6.1-12.6z"></path></svg></i>
        buffer
      </a></span> <!----></p></div> </main> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.35af8aa6.js" defer></script><script src="/assets/js/3.dc37dcdc.js" defer></script><script src="/assets/js/7.20c81c08.js" defer></script>
  </body>
</html>